{"repo_token":"XKUga6etuxSWYPXJ0lAiDyHM2jbKPQAKC","source_files":[{"name":"League\/PHPUnitCoverageListener\/Collection.php","source":"<?php namespace League\\PHPUnitCoverageListener;\n\nuse \\IteratorAggregate;\nuse \\Countable;\n\n\/**\n * Collection class\n *\n * @package  League\\PHPUnitCoverageListener\n * @author   Taufan Aditya <toopay@taufanaditya.com>\n *\/\n\nclass Collection implements IteratorAggregate, Countable\n{\n    \/**\n     * Parameter storage.\n     *\n     * @var array\n     *\/\n    protected $parameters;\n\n    \/**\n     * Constructor.\n     *\n     * @param array $parameters An array of parameters\n     *\n     * @api\n     *\/\n    public function __construct(array $parameters = array())\n    {\n        $this->parameters = $parameters;\n    }\n\n    \/**\n     * Returns the parameters.\n     *\n     * @return array An array of parameters\n     *\/\n    public function all()\n    {\n        return $this->parameters;\n    }\n\n    \/**\n     * Adds parameters.\n     *\n     * @param array $parameters An array of parameters\n     *\/\n    public function add(array $parameters = array())\n    {\n        $this->parameters = array_replace($this->parameters, $parameters);\n    }\n\n    \/**\n     * Sets a parameter by name.\n     *\n     * @param string $key   The key\n     * @param mixed  $value The value\n     *\/\n    public function set($key, $value)\n    {\n        $this->parameters[$key] = $value;\n    }\n\n    \/**\n     * Returns true if the parameter is defined.\n     *\n     * @param string $key The key\n     *\n     * @return Boolean true if the parameter exists, false otherwise\n     *\/\n    public function has($key)\n    {\n        return array_key_exists($key, $this->parameters);\n    }\n\n    \/**\n     * Removes a parameter.\n     *\n     * @param string $key The key\n     *\/\n    public function remove($key)\n    {\n        unset($this->parameters[$key]);\n    }\n\n    \/**\n     * Returns an iterator for parameters.\n     *\n     * @return \\ArrayIterator An \\ArrayIterator instance\n     *\/\n    public function getIterator()\n    {\n        return new \\ArrayIterator($this->parameters);\n    }\n\n    \/**\n     * Returns the number of parameters.\n     *\n     * @return int The number of parameters\n     *\/\n    public function count()\n    {\n        return count($this->parameters);\n    }\n}\n","coverage":[null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,4,4,null,null,null,null,null,null,null,null,1,null,null,null,null,null,null,null,null,null,1,1,null,null,null,null,null,null,null,null,null,1,1,null,null,null,null,null,null,null,null,null,null,1,null,null,null,null,null,null,null,null,null,1,1,null,null,null,null,null,null,null,null,1,null,null,null,null,null,null,null,null,null,2,null,null,1]},{"name":"League\/PHPUnitCoverageListener\/Listener.php","source":"<?php namespace League\\PHPUnitCoverageListener;\n\nuse League\\PHPUnitCoverageListener\\ListenerInterface;\nuse League\\PHPUnitCoverageListener\\PrinterInterface;\nuse League\\PHPUnitCoverageListener\\HookInterface;\nuse League\\PHPUnitCoverageListener\\Collection;\nuse \\SimpleXMLElement;\n\n\/**\n * Main PHPUnit listener class\n *\n * @package  League\\PHPUnitCoverageListener\n * @author   Taufan Aditya <toopay@taufanaditya.com>\n *\/\n\nclass Listener implements ListenerInterface\n{\n\t\/**\n\t * @var PrinterInterface\n\t *\/\n\tprotected $printer;\n\n\t\/**\n\t * @var HookInterface\n\t *\/\n\tprotected $hook;\n\n    \/**\n     * Listener constructor\n     *\n     * @param array Argument that sent from phpunit.xml\n     * @param bool Boot flag \n     *\/\n    public function __construct($args = array(), $boot = true)\n    {\n        $this->ensurePrinter($args);\n\n    \t$this->printer = $args['printer'];\n\n    \t\/\/ @coverageIgnoreStart\n        if ($boot) {\n\t    \t$listener = $this;\n\n\t        \/\/ Register the method to collect code-coverage information\n\t        register_shutdown_function(function() use ($args, $listener) {\n\t            $listener->collectAndSendCoverage($args);\n\t        });\n        }\n    \t\/\/ @coverageIgnoreEnd\n    }\n\n    \/**\n     * Printer getter\n     *\n     * @return PrinterInterface\n     *\/\n    public function getPrinter()\n    {\n    \treturn $this->printer;\n    }\n\n    \/**\n     * Main api for collecting code-coverage information\n     *\n     * @param array Contains repo secret hash, target url, coverage directory and optional Namespace\n     *\/\n    public function collectAndSendCoverage($args)\n    {\n        \/\/ Starting point!\n        $this->printer->out(\"\\n\\n\".'Collecting CodeCoverage information...');\n\n        if (array_key_exists('repo_token', $args) \n            && array_key_exists('target_url', $args)\n            && array_key_exists('coverage_dir', $args)\n            && array_key_exists('namespace', $args)) {\n            extract($args);\n\n            \/\/ Check for exist and valid hook\n            if (isset($hook) && $hook instanceof HookInterface) {\n            \t$this->hook = $hook;\n            \tunset($hook);\n            }\n\n            \/\/ Get the realpath coverage directory\n            $coverage_dir = realpath($coverage_dir);\n            $coverage_file = $coverage_dir.DIRECTORY_SEPARATOR.self::COVERAGE_FILE;\n            $coverage_output = $coverage_dir.DIRECTORY_SEPARATOR.self::COVERAGE_OUTPUT;\n\n            \/\/ Get the coverage information\n            if (is_dir($coverage_dir) && is_file($coverage_file)) {\n            \t\/\/ Build the coverage xml object\n\t\t        $xml = file_get_contents($coverage_file);\n\t\t        $coverage = new SimpleXMLElement($xml);\n\n                \/\/ Prepare the coveralls payload\n                $data = $this->collect($coverage, $args);\n\n                \/\/ Write the coverage output\n                $this->printer->out('Writing coverage output...');\n                file_put_contents($coverage_output, json_encode($data->all(), JSON_NUMERIC_CHECK));\n\n                \/\/ Send it!\n                $this->printer->out('Sending coverage output...');\n                $payload = array('json_file'=>'@'.$coverage_output); \n                $ch = curl_init(); \n                curl_setopt($ch, CURLOPT_URL, $target_url); \n                curl_setopt($ch, CURLOPT_POST,1); \n                curl_setopt($ch, CURLOPT_POSTFIELDS, $payload);\n\n                \/\/ Save output into output buffer\n                ob_start();\n                $result = curl_exec ($ch); \n                $curlOutput = ob_get_contents();\n                ob_end_clean();\n\n                curl_close ($ch); \n                $this->printer->printOut('cURL Output:'.$curlOutput); \n                $this->printer->printOut('cURL Result:'.$result);\n            }\n        }\n\n        $this->printer->out('Done.');\n    }\n\n    \/**\n     * Printer validator\n     *\n     * @param array\n     *\/\n    protected function ensurePrinter($args)\n    {\n        if ( ! isset($args['printer'])) {\n            throw new \\RuntimeException('Printer class not found');\n        }\n\n\n        if ( ! $args['printer'] instanceof PrinterInterface) {\n            throw new \\RuntimeException('Invalid printer class');\n        }\n    }\n\n    \/**\n     * Main collector method\n     *\n     * @param SimpleXMLElement Coverage report from PHPUnit\n     * @param array\n     * @return Collection\n     *\/\n    protected function collect(SimpleXMLElement $coverage, $args = array())\n    {\n    \textract($args);\n\n    \t$data = new Collection(array(\n            'repo_token' => $repo_token,\n            'source_files' => array(),\n        ));\n\n \t\t\/\/ Before collect hook\n     \tif ( ! empty($this->hook)) {\n     \t\t$data = $this->hook->beforeCollect($data);\n     \t}\n\n        \/\/ Prepare temporary source_files holder\n        $sourceArray = new Collection();\n\n        if (count($coverage->project->package) > 0) {\n            \/\/ Iterate over the package\n            foreach ($coverage->project->package as $package) {\n                \/\/ Then itterate on each package file\n                foreach ($package->file as $packageFile) {\n                    $this->printer->printOut('Checking:'.$packageFile['name']);\n\n                    $sourceArray->add(array(\n                        md5($packageFile['name']) => $this->collectFromFile($packageFile, $namespace)\n                    ));\n                }\n            }\n        }\n\n        if (count($coverage->project->file) > 0) {\n            \/\/ itterate over the files\n            foreach ($coverage->project->file as $file) {\n                $this->printer->printOut('Checking:'.$file['name']);\n\n                $sourceArray->add(array(\n                    md5($file['name']) => $this->collectFromFile($file, $namespace)\n                ));\n            }\n        }\n\n        \/\/ Last, pass the source information it it contains any information\n        if ($sourceArray->count() > 0) {\n            $data->set('source_files', array_values($sourceArray->all()));\n        }\n\n \t\t\/\/ After collect hook\n        if ( ! empty($this->hook)) {\n     \t\t$data = $this->hook->afterCollect($data);\n     \t}\n\n     \treturn $data;\n    }\n\n    \/**\n     * Collect code-coverage information from a file\n     *\n     * @param SimpleXMLElement contains coverage information\n     * @param string Optional file namespace identifier\n     * @return array contains code-coverage data with keys as follow : name, source, coverage\n     *\/\n    protected function collectFromFile(SimpleXMLElement $file, $namespace = '')\n    {\n        \/\/ Get current dir\n        $currentDir = (isset($_SERVER['PWD'])) ? realpath($_SERVER['PWD']) : getcwd();\n\n        \/\/ Initial return values\n        $name = '';\n        $source = '';\n        $coverage = array();\n\n        \/\/ #1 Get the relative file name\n        list($path, $relativeName) = explode($currentDir, $file['name']);\n\n        if (empty($namespace)) {\n            \/\/ @coverageIgnoreStart\n            $name = trim($relativeName, DIRECTORY_SEPARATOR);\n        } else {\n            \/\/ @coverageIgnoreEnd\n            \/\/ Replace backslash with directory separator\n            $ns = str_replace('\\\\', DIRECTORY_SEPARATOR, $namespace);\n            list($path, $namespacedName) = explode($ns, $relativeName);\n\n            $name = $ns.DIRECTORY_SEPARATOR.trim($namespacedName, DIRECTORY_SEPARATOR);\n        }\n\n        \/\/ #2 Build coverage data and the source code\n        $count = 0;\n        $handle = fopen($file['name'], \"r\");\n        while(!feof($handle)){\n            $source .= fgets($handle);\n            $count++;\n        }\n\n        fclose($handle);\n\n        \/\/ Here we build the default coverage values\n        $coverage = array_fill(0, $count, null);\n\n        \/\/ Then, we will overwrite any coverage block into it!\n        if (count($file->line) > 0) {\n            foreach ($file->line as $line) {\n                $attributes = current($line->attributes());\n\n                \/\/ Only stmt would be count\n                if (isset($attributes['type']) \n                    && isset($attributes['count']) \n                    && $attributes['type'] === 'stmt') {\n\n                    \/\/ Decrease the line number by one\n                    \/\/ since key 0 (within coverage array) is actually line number 1\n                    $num = (int) $attributes['num'] - 1;\n\n                    \/\/ Ensure it match count boundaries\n                    if ($num > 0 && $num <= $count) {\n                        $coverage[$num] = (int) $attributes['count'];\n                    }\n                }\n            }\n        }\n\n        return compact('name', 'source', 'coverage');\n    }\n}","coverage":[null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,3,1,null,null,2,1,null,null,1,null,null,1,0,null,null,null,0,0,0,null,1,null,null,null,null,null,null,null,null,1,null,null,null,null,null,null,null,null,null,null,0,null,0,0,0,0,0,null,null,0,0,0,0,null,null,0,0,0,null,null,0,null,0,0,null,null,0,null,null,0,0,null,null,0,0,0,0,0,0,null,null,0,0,0,0,null,0,0,0,0,0,null,0,0,null,null,null,null,null,null,null,null,null,null,0,null,0,0,0,0,null,null,0,0,0,null,null,0,null,0,null,0,null,0,0,null,0,0,0,0,0,0,null,0,null,0,0,null,0,0,0,0,0,null,null,0,0,0,null,null,0,0,0,null,0,null,null,null,null,null,null,null,null,null,null,null,null,null,null,0,null,null,0,0,0,null,null,0,null,0,0,0,null,0,0,null,0,null,null,null,0,0,0,0,0,0,null,0,null,null,0,null,null,0,0,0,null,null,0,0,0,null,null,null,0,null,null,0,0,0,0,0,0,null,0,null,null,null,null,null,null,null,null,null,null,null,null,null]},{"name":"League\/PHPUnitCoverageListener\/Hook\/Travis.php","source":"<?php namespace League\\PHPUnitCoverageListener\\Hook;\n\nuse League\\PHPUnitCoverageListener\\HookInterface;\nuse League\\PHPUnitCoverageListener\\Collection;\n\n\/**\n * Travis Hook\n *\n * @package  League\\PHPUnitCoverageListener\n * @author   Taufan Aditya <toopay@taufanaditya.com>\n *\/\n\nclass Travis implements HookInterface\n{\n    \/**\n     *{@inheritdoc}\n     *\/\n    public function beforeCollect(Collection $data)\n    {\n        \/\/ Check for Travis-CI environment\n        \/\/ if it appears, then assign it respectively\n        if (getenv('TRAVIS_JOB_ID') || isset($_ENV['TRAVIS_JOB_ID'])) {\n            \/\/ Remove repo token\n            $data->remove('repo_token');\n\n            \/\/ And use travis config\n            $travis_job_id = isset($_ENV['TRAVIS_JOB_ID']) ? $_ENV['TRAVIS_JOB_ID'] : getenv('TRAVIS_JOB_ID');\n            $data->set('service_name', 'travis-ci');\n            $data->set('service_job_id', $travis_job_id);\n        }\n\n        return $data;\n    }\n\n    \/**\n     *{@inheritdoc}\n     *\/\n    public function afterCollect(Collection $data)\n    {\n        return $data;\n    }\n}","coverage":[null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,0,null,0,null,null,0,0,0,null,0,null,null,null,null,null,null,null,0,null,null,null]},{"name":"League\/PHPUnitCoverageListener\/Printer\/ArrayOut.php","source":"<?php namespace League\\PHPUnitCoverageListener\\Printer;\n\nuse League\\PHPUnitCoverageListener\\PrinterInterface;\n\n\/**\n * Array printer\n *\n * @package  League\\PHPUnitCoverageListener\n * @author   Taufan Aditya <toopay@taufanaditya.com>\n *\/\n\nclass ArrayOut implements PrinterInterface\n{\n    \/**\n     * @var array Output array\n     *\/\n    public $output = array();\n\n    \/**\n     *{@inheritdoc}\n     *\/\n    public function out($output = '')\n    {\n        $this->output[] = $output.\"\\n\";\n    }\n\n    \/**\n     *{@inheritdoc}\n     *\/\n    public function printOut($output = '')\n    {\n        $this->output[] = str_pad(' ', 2, '*').' '.$output;\n    }\n}","coverage":[null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,0,0,null,null,null,null,null,null,0,0,null]}]}